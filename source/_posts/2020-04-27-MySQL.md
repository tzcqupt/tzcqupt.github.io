layout: post
title: MySQL学习笔记
Author: tzcqupt
tags:
  - Java
  - MySQL
comments: true
toc: true
date: 2020-04-27 00:00:00
---
# 前言
> 代码参考[mysql相关学习](https://gitee.com/tangtz/JavaLearn/blob/feature/JavaEE_Learn/src/main/java/com/tang/mysql/mysql相关学习.sql),安装mysql参考[mysql安装指南](./数据库安装指南.md)

# MySQL数据库软件 

- MySQL服务启动
    1. 手动。
    2. cmd--> services.msc 打开服务的窗口
    3. 使用管理员打开cmd
        * `net start mysql` 
        启动mysql的服务
        * `net stop mysql` 
        关闭mysql服务
          
            >服务名不一定为mysql,跟自己安装的版本有关系,需要查看windows的服务查看mysql服务名
- MySQL登录
	1. ```mysql -uroot -p密码```
	2. ```mysql -hip -uroot -p连接目标的密码```
	3. ```mysql --host=ip --user=root --password=连接目标的密码```
- MySQL退出
	* ```exit```
	* ```quit```
- 数据库备份和还原
    - 备份  
  ```mysqldump -u 用户名 -p 密码 数据库 > 要存储的文件路径 ```
    - 还原   
  ```USE 数据库;SOURCE 导入文件的路径;```
  
# SQL

1. 什么是SQL？
	Structured Query Language：结构化查询语言  
	其实就是定义了操作所有关系型数据库的规则。每一种数据库操作的方式存在不一样的地方，称为“方言”。	
2. SQL通用语法
	1. SQL 语句可以单行或多行书写，以分号结尾。
	2. 可使用空格和缩进来增强语句的可读性。
	3. MySQL 数据库的 SQL 语句不区分大小写，关键字建议使用大写。
	4. 3 种注释  
		* 单行注释: -- 注释内容 或 # 注释内容(mysql 特有) 
		* 多行注释: /* 注释 */		
3. SQL分类
	1. DDL(Data Definition Language)数据定义语言   
        用来定义数据库对象：数据库，表，列等。关键字：```create, drop, alter``` 等
	2. DML(Data Manipulation Language)数据操作语言  
		用来对数据库中表的数据进行增删改。关键字：```insert, delete, update``` 等
	3. DQL(Data Query Language)数据查询语言  
		用来查询数据库中表的记录(数据)。关键字：```select, where``` 等
	4. DCL(Data Control Language)数据控制语言(了解)  
		用来定义数据库的访问权限和安全级别，及创建用户。关键字：```GRANT, REVOKE``` 等
       
	
# DDL:操作数据库、表

##  数据库CRUD
1. C(Create):创建
   * 创建数据库  
    ```create database 数据库名称;```
   * 创建数据库，判断不存在，再创建  
    ```create database if not exists 数据库名称;```
   * 创建数据库，并指定字符集  
    ```create database 数据库名称 character set 字符集名;```
   * 练习:创建db4数据库，判断是否存在，并制定字符集为gbk  
    ```create database if not exists db4 character set gbk;```
2. R(Retrieve)：查询
   * 查询所有数据库的名称  
    ```show databases;```
   * 查询某个数据库的字符集:查询某个数据库的创建语句  
    ```show create database 数据库名称;```
3. U(Update):修改  
修改数据库的字符集  
    ```alter database 数据库名称 character set 字符集名称;```
4. D(Delete):删除
   * 删除数据库  
    ```drop database 数据库名称;```
   * 判断数据库存在，存在再删除  
    ```drop database if exists 数据库名称;```
5. 使用数据库  
   * 查询当前正在使用的数据库名称  
    ```select database();```
   * 使用数据库  
    ```use 数据库名称;```	
    
## 操作表CRUD

### C(Create):创建

- 语法  
   ```sql
   create table 表名(
                       列名1 数据类型1,
                       列名2 数据类型2,
                       ....
                       列名n 数据类型n
                    );
  ```
     >注意：最后一列，不需要加逗号(,)
- 数据类型：
  1. int：整数类型    
    ```age int,```
  2. double:小数类型  
    ```score double(5,2)```
  3. date:日期，只包含年月日  
    ```yyyy-MM-dd```
  4. datetime:日期，包含年月日时分秒  
    ```yyyy-MM-dd HH:mm:ss```
  5. timestamp:时间错类型	包含年月日时分秒  
    ```yyyy-MM-dd HH:mm:ss ``` 	
  	>如果将来不给这个字段赋值，或赋值为null，则默认使用当前的系统时间，来自动赋值
  6. varchar：字符串
    ```name varchar(20)```:姓名最大20个字符
     
     > zhangsan 8个字符  
     > 张三 2个字符
- 创建表

	```sql
	create table student(
	id int,
	name varchar(32),
	age int ,
	score double(4,1),
	birthday date,
	insert_time timestamp
	);
	```
- 复制表：  
    ```create table 表名 like 被复制的表名;```	
    
### R(Retrieve)：查询

* 查询某个数据库中所有的表名称  
    ```show tables;```
* 查询表结构  
    ```desc 表名;```
    
### U(Update):修改
1. 修改表名  
    ```alter table 表名 rename to 新的表名;```
2. 修改表的字符集  
    ```alter table 表名 character set 字符集名称;```
3. 添加一列  
    ```alter table 表名 add 列名 数据类型;```
4. 修改列名称 类型  
    ```alter table 表名 change 列名 新列别 新数据类型;```  
    ```alter table 表名 modify 列名 新数据类型;```
5. 删除列  
    ```alter table 表名 drop 列名;```
4. D(Delete):删除  
    ```drop table 表名;```  
    ```drop table  if exists 表名 ;```
    
# DML:增删改表中数据

## 添加数据

  ```insert into 表名(列名1,列名2,...列名n) values(值1,值2,...值n);```
1. 列名和值要一一对应。    
2. 如果表名后，不定义列名，则默认给所有列添加值   
	```insert into 表名 values(值1,值2,...值n);```  	
3. 除了数字类型，其他类型需要使用引号(单双都可以)引起来

## 删除数据  
  ```delete from 表名 [where 条件];```  
    
1. 如果不加条件，则删除表中所有记录。  
2. 如果要删除所有记录  
	1. ```delete from 表名;``` -- ***不推荐使用***。有多少条记录就会执行多少次删除操作  
	2. ```TRUNCATE TABLE 表名;``` -- **推荐使用**，效率更高 先删除表，然后再创建一张一样的表。
    
## 修改数据
    ```update 表名 set 列名1 = 值1, 列名2 = 值2,... [where 条件];```

>如果不加任何条件，则会将表中所有记录全部修改。

# DQL:查询表中的记录 简单查询
   ```select * from 表名;```
## 语法
```sql
select
	字段列表
from
	表名列表
where
	条件列表
group by
	分组字段
having
	分组之后的条件
order by
	排序
limit
	分页限定
```

## 基础查询
1. 多个字段的查询  
    ```select 字段名1，字段名2... from 表名;```  

	>如果查询所有字段，则可以使用*来替代字段列表。
2. 去除重复  
    ```distinct```
3. 计算列
   1. 一般可以使用四则运算计算一些列的值。（一般只会进行数值型的计算）
   2. ifnull(列名,默认值)  
       判断列名的值是否为 NULL,如果为 NULL 则返回第二个参数,如果不为 NULL 则返回第一个参数的值。  
4. 起别名```as```  
   >as也可以省略
	
## 条件查询
1. where子句后跟条件
2. 运算符
   * ```> 、< 、<= 、>= 、= 、<>```
   * ```BETWEEN...AND ```
   * ```IN(集合)```
   * ```LIKE：模糊查询```  
占位符：
   * ```_``` 单个任意字符
   * ```%``` 多个任意字符
   * ```IS NULL ``` 
   * ```and``` 或 ```&&```
   * ```or ``` 或 ```||``` 
   * ``` not```  或 ```!```

- 查询年龄大于20岁

    ```SELECT * FROM student WHERE age > 20;```     

    ```SELECT * FROM student WHERE age >= 20;```
	
- 查询年龄等于20岁  
	```SELECT * FROM student WHERE age = 20;```
	
- 查询年龄不等于20岁  
	```SELECT * FROM student WHERE age != 20;```

	```SELECT * FROM student WHERE age <> 20;```
	
- 查询年龄大于等于20 小于等于30  
	
	```SELECT * FROM student WHERE age >= 20 &&  age <=30;```

	```SELECT * FROM student WHERE age >= 20 AND  age <=30;```

	```SELECT * FROM student WHERE age BETWEEN 20 AND 30;```
	
- 查询年龄22岁，18岁，25岁的信息  
	```SELECT * FROM student WHERE age = 22 OR age = 18 OR age = 25```

	```SELECT * FROM student WHERE age IN (22,18,25);```
	
- 查询英语成绩为null  
	```SELECT * FROM student WHERE english = NULL; ```
   >不对的。null值不能使用 = (!=) 判断
	
	```SELECT * FROM student WHERE english IS NULL;```
	
- 查询英语成绩不为null  
	```SELECT * FROM student WHERE english  IS NOT NULL;```

- 查询姓马的有哪些？ like    
	```SELECT * FROM student WHERE NAME LIKE '马%';```
- 查询姓名第二个字是化的人     
	```SELECT * FROM student WHERE NAME LIKE "_化%";```
	
- 查询姓名是3个字的人    
	```SELECT * FROM student WHERE NAME LIKE '___';```
- 查询姓名中包含德的人   
	```SELECT * FROM student WHERE NAME LIKE '%德%';```
    
# DQL:查询语句 复杂查询

## 排序查询

* 语法：order by 子句  
    ```order by 排序字段1 排序方式1 ，  排序字段2 排序方式2...```
* 排序方式
  * ```ASC```：升序，默认的。
  * ```DESC```：降序。
>如果有多个排序条件，则当前边的条件值一样时，才会判断第二条件。  
      如学生有年龄和成绩,先按照成绩降序排名,如果成绩一样,按照年龄升序排名给出结果

## 聚合函数 

将一列数据作为一个整体，进行纵向的计算。
1. `count`：计算个数
	1. 一般选择非空的列：主键
	2. `count(*)`
2. ```max```：计算最大值
3. ```min```：计算最小值
4. ```sum```：计算和
5. ```avg```：计算平均值
>聚合函数的计算，排除```null```值。  
	1. 选择不包含非空的列进行计算  
	2. ```IFNULL```函数
    
## 分组查询

1. group by 分组字段；
	
	>分组之后查询的字段：分组字段、聚合函数
2. where 和 having 的区别？  
   1. where 在**分组之前**进行限定，如果不满足条件，则不参与分组。having在**分组之后**进行限定，如果不满足结果，则不会被查询出来
   2. where 后不可以跟聚合函数，**having可以进行聚合函数的判断**。
- 按照性别分组。分别查询男、女同学的平均分  

    ```SELECT sex , AVG(math) FROM student GROUP BY sex;```

- 按照性别分组。分别查询男、女同学的平均分,人数  

    ```SELECT sex , AVG(math),COUNT(id) FROM student GROUP BY sex;```

-  按照性别分组。分别查询男、女同学的平均分,人数 要求：分数低于70分的人，不参与分组  
    ```SELECT sex , AVG(math),COUNT(id) FROM student WHERE math > 70 GROUP BY sex;```

-  按照性别分组。分别查询男、女同学的平均分,人数 要求：分数低于70分的人，不参与分组,分组之后。人数要大于2个人  
    ```SELECT sex , AVG(math),COUNT(id) FROM student WHERE math > 70 GROUP BY sex HAVING COUNT(id) > 2;```  
    ```SELECT sex , AVG(math),COUNT(id) 人数 FROM student WHERE math > 70 GROUP BY sex HAVING 人数 > 2;```	
    
## 分页查询

1. 语法：```limit``` 开始的索引,每页查询的条数;
2. 公式：开始的索引 = （当前的页码 - 1） * 每页显示的条数<==>当前页=(索引/条数)+1  
每页显示3条记录 

	```SELECT * FROM student LIMIT 0,3;``` -- 第1页=(0/3)+1

	```SELECT * FROM student LIMIT 3,3;``` -- 第2页=(3/3)+1

	```SELECT * FROM student LIMIT 6,3;``` -- 第3页=(6/3)+1

>```limit``` 是一个MySQL"方言",limit开始的索引默认为0,从0开始计数

# 联合查询

有学生表，分数表，课程表==>查询每门功课成绩最好的前两名

union 不能在 order by/limit后使用。可以使用select a.* from(slect…order by s.score limit 0,2)a union all select b.* from(..) b

~~~sql
select a.* from (select s.*, c.c_name, s2.s_score
from student s
         join score s2 on s.s_id = s2.s_id
         left join course c on s2.c_id = c.c_id
where s2.c_id = "01" order by s2.s_score desc limit 0,2) a
union all
select b.* from (select s.*, c.c_name, s2.s_score
from student s
         join score s2 on s.s_id = s2.s_id
         left join course c on s2.c_id = c.c_id
where s2.c_id = "02"  order by s2.s_score desc limit 0,2) b
union all
select c.* from (select s.*, c.c_name, s2.s_score
from student s
         join score s2 on s.s_id = s2.s_id
         left join course c on s2.c_id = c.c_id
where s2.c_id = "03"
order by s_score desc limit 0,2)c
~~~


# 约束

## 概念

对表中的数据进行限定，保证数据的正确性、有效性和完整性。

## 分类

1. 主键约束 ```primary key```
2. 非空约束 ```not null```
3. 唯一约束 ```unique```
4. 外键约束 ```foreign key```

## 约束解释

### 非空约束

```not null```,值不能为null

1. 创建表时添加约束

   ```sql
   CREATE TABLE stu(
       id INT,
       NAME VARCHAR(20) NOT NULL -- name为非空
    );
   ```
2. 创建表完后,添加非空约束  
​```ALTER TABLE stu MODIFY NAME VARCHAR(20) NOT NULL;```
3. 删除name的非空约束  
   ```ALTER TABLE stu MODIFY NAME VARCHAR(20);``` 
   
### 唯一约束

`unique`,值不能重复

1. 创建表时,添加唯一约束

	```sql 
	CREATE TABLE stu(
		id INT,
		phone_number VARCHAR(20) UNIQUE, -- 添加了唯一约束
		address VARCHAR(20) default '北京' -- 给某一列设置默认值
		);
	```

	>注意mysql中,唯一约束限定的列的值可以有多个null       
2. 删除唯一约束  

  	```ALTER TABLE stu DROP INDEX phone_number;```
       
3. 在创建表后,添加唯一约束  
    ```ALTER TABLE stu MODIFY phone_number VARCHAR(20) UNIQUE;```
    
### 主键约束

`primary key`

#### 定义

1. 含义：非空且唯一
2. 主键数在一个表中，只能有一个。不能出现多个主键。主键可以单列,也可以是多列。 联合主键
3. 主键就是表中记录的唯一标识

#### 使用

1. 在创建表时,添加主键约束
	```sql
	create table stu(
		id int primary key,-- 给id添加主键约束
		name varchar(20)
	);
	```
	
2. 删除主键
	
	~~~sql
	-- 错误 alter table stu modify id int ; 
	ALTER TABLE stu DROP PRIMARY KEY;
	~~~
	
3. 创建完表后,添加主键  
    ```ALTER TABLE stu MODIFY id INT PRIMARY KEY;```
    
#### 设置主键自动增长

1. 概念：如果某一列是数值类型的，使用 ```auto_increment``` 可以来完成值得自动增长

2. 在创建表时，添加主键约束，并且完成主键自增长

    ```sql
    create table stu(
        id int primary key auto_increment,-- 给id添加主键约束
        name varchar(20)
    );
    -- 创建完成之后,修改主键自增的起始值
    alter table stu auto_increment = 2000; 
 	-- 创建的时候修改主键自增的起始值,默认值为1
	create table stu(
		id int primary key auto_increment,-- 给id添加主键约束
		name varchar(20)
	) auto_increment = 1000; 
	```
3. 删除自动增长  
    ```ALTER TABLE stu MODIFY id INT;```
4. 添加自动增长  
    ```ALTER TABLE stu MODIFY id INT AUTO_INCREMENT;```
    
### 外键约束

 `foreign key`,让表于表产生关系，从而保证数据的正确性。
1. 在创建表时，可以添加外键

	```sql
	create table 表名(
	....
	外键列
	[constraint] [外键名称] foreign key (外键列名称) references 主表名称(主表列名称)
	);
	```
2. 删除外键  
    ```ALTER TABLE 表名 DROP FOREIGN KEY 外键名称;```

3. 创建表之后，添加外键   
    ```ALTER TABLE 表名 ADD [CONSTRAINT] [外键名称] FOREIGN KEY (外键字段名称) REFERENCES 主表名称(主表列名称);```	
4. 级联操作
   1. 添加级联操作

        ```sql
        ALTER TABLE 表名 ADD [CONSTRAINT] [外键名称] 
        FOREIGN KEY (外键字段名称) REFERENCES 主表名称(主表列名称) ON UPDATE CASCADE ON DELETE CASCADE;
        ```
   2. 分类：
      1. 级联更新：```ON UPDATE CASCADE``` 
      2. 级联删除：```ON DELETE CASCADE```

# 问题记录

## Linux中文乱码解决

在数据库的配置文件中 my.cnf配置
- character_set_client=utf8
- character_set_server=utf8

## 表设计

建立外键时，需确保两者字段类型统一，如 是否是 unsigned

# PowerDesigner使用

## 设置一对多

如：班级和学生(包含class_number)就是一对多 

箭头方向：学生(多/子)======>班级(一/父)

## 设置一对一

学生表(包含身份证主键card_number)和身份信息表

箭头方向都可以

## 格式化

全选==>右键==>auto layer