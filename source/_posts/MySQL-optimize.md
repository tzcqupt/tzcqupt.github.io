---
layout: post
title: MySQL 优化学习
Author: tzcqupt
tags: [ MySQL]
categories: [数据库]
comments: true
toc: true
date: 2020-05-23 00:00:00
---

# MySQL 基本架构

## 基础说明

![](http://img.tzcqupt.top/MySQL-base.png)

MySQL 分为 Server 层和存储引擎层两部分

Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

存储引擎层负责数据的存储和提取.

# MySQL优化

## 单表查询优化

1. 明确需要的字段,而不是select *
2. 使用连接JOIN 代替子查询
3. 使用分页语句(limit [offset,] rows) 或者where 字句时,有什么限制条件就尽量加上,查一条就limit 1

## 多表查询优化

多表查询包括 `INNER JOIN`/`LEFT JOIN`/`RIGHT JOIN`

`cross join(交叉连接)`==> 两个表的笛卡尔积

### JOIN 实现原理

MySQL 中的JOIN算法==>Nested Loop Join,就是通过驱动表的结果集作为循环基础数据,然后一条一条的通过该结果集中的数据作为过滤条件到下一个表中查询数据,然后合并结果.

### 优化结论

1. 内连接加上`ON`限定条件,否则会被解释为交叉连接

2. 连接表格使用` , `会被解释为交叉连接

3. 超大型数据尽可能不写子查询,使用JOIN替换

   1. **当查询出来的数据需要进一步处理时,采用子查询,可读性和效率都更好**
   2. 特定的场景,如直接从数据库中读取,采用`JOIN`比`WHERE` 快

4. 使用`UNION`来代替手动创建的临时表

   1. `UNION`就是把两次或多次查询结果合并起来
   2. `UNION`会去掉重复的行,而`UNION ALL`不会
   3. 子句中有`ORDER BY/LIMIT`需要用括号`()`包起来,推荐放到所有字句后,对最终合并的结果来排序或筛选

5. 尽量避免在 `WHERE`子句中对字段进行`NULL`值判断,否则将导致引擎放弃使用索引而进行全表扫描.

6. `IN`和`NOT IN`也要慎用,否则导致全盘扫描

   1. 对于连续的数值,采用`BETWEEN AND`

   2. 采用 `EXISTS`代替`IN`

      ~~~mysql
      select id from t where num in(1,2,3)
      #====>
      select id from t where num between 1 and 3
      
      select num from a where num in(select num from b)
      #====>
      select num from a where exists(select 1 from b where num=a.num)
      ~~~

7. **尽量使用数字型字段**,若只包含数值信息的字段尽量不要设计为字符型,这会降低查询和连接的性能,增加内存开销. 是因为引擎在处理查询和连接时会逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了 

8. 尽量使用表变量来代替临时表
9. 索引才能将MySQL的查询优化得更好

## 慢查询优化

### 开启慢查询日志

~~~sql
show variables like 'slow_query_log'  
--查看是否开启慢查询日志
-- 查看慢查询的日志位置
show variables like '%log%';
set global slow_query_log_file='/var/lib/mysql/VM_0_17_centos-slow.log';
--慢查询日志的位置

set global slow_query_log =on;
--开启慢查询日志

set global long_query_time=1;  
--大于1秒钟的数据记录到慢日志中，如果设置为默认0，则会有大量的信息存储在磁盘中，磁盘很容易满掉
~~~

### 分析日志

1. MySQL提供的 **mysqldumpslow**

~~~mysql
#slow记录最多的10个语句
mysqldumpslow -s r -t 10 /VM_0_17_centos-slow.log 
#按照时间排序前10中含有 left join的
mysqldumpslow -s r -t 10 -g "left join" /VM_0_17_centos-slow.log 
~~~

2. **mysqlsla**工具

    mysqlsla会自动判断日志类型,建立一个配置文件`.mysqlsla`在文件里写上`top=100`,这样会打印出前100条结果.参数说明:

   ~~~
   queries total: 总查询次数 unique:去重后的sql数量
   sorted by : 输出报表的内容排序
   
   最重大的慢sql统计信息, 包括 平均执行时间, 等待锁时间, 结果行的总数, 扫描的行总数.
   
   Count, sql的执行次数及占总的slow log数量的百分比.
   Time, 执行时间, 包括总时间, 平均时间, 最小, 最大时间, 时间占到总慢sql时间的百分比.
   95% of Time, 去除最快和最慢的sql, 覆盖率占95%的sql的执行时间.
   Lock Time, 等待锁的时间.
   95% of Lock , 95%的慢sql等待锁时间.
   Rows sent, 结果行统计数量, 包括平均, 最小, 最大数量.
   Rows examined, 扫描的行数量.
   Database, 属于哪个数据库
   Users, 哪个用户,IP, 占到所有用户执行的sql百分比
   Query abstract, 抽象后的sql语句
   Query sample, sql语句
   ~~~

   

# MySQL 索引

## 索引的基本原理

 通过不断地缩小想要获取数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件 ===>**把无序的数据变成有序的数据**

1. 把创建了索引的列的内容进行排序

2. 对排序结果生成倒排表

3. 在倒排表内容上拼上数据地址链

4. 在查询的时候，先拿到倒排表内容，再取出数据地址链，从而拿到具体数据

## 硬盘中数据的读取

### 硬盘中的概念

以机械硬盘为例.

#### 扇区

 磁盘存储的最小单位，扇区一般大小为512Byte。 

#### 硬盘块

 文件系统与磁盘交互的的最小单位（计算机系统读写磁盘的最小单位），一个磁盘块由连续几个（2^n）扇区组成，块一般大小一般为4KB。 

#### 硬盘读取数据

 磁盘读取数据靠的是机械运动，每次读取数据花费的时间可以分为**寻道时间、旋转延迟、传输时间**三个部分 .

##### 寻道时间 

 磁臂移动到指定磁道所需要的时间，主流磁盘一般在5ms以下 

##### 旋转延迟

 旋转延迟就是我们经常听说的磁盘转速，比如一个磁盘7200转，表示每分钟能转7200次，也就是说1秒钟能转120次，旋转延迟就是1/120/2 = 4.17ms 

##### 传输时间

 传输时间指的是从磁盘读出或将数据写入磁盘的时间，一般在零点几毫秒，相对于前两个时间可以忽略不计 

## InnoDB 中的索引

### 索引解释

**InnoDB中有2种索引：**主键索引（聚集索引）、辅助索引（非聚集索引）。

**主键索引：**每个表只有一个主键索引，叶子节点同时保存了主键的值也数据记录。

**辅助索引：**叶子节点保存了索引字段的值以及主键的值。

辅助索引的查询过程在MySQL中叫做回表.

### 创建索引的原则

1. 最左前缀匹配原则，组合索引非常重要的原则，MySQL会一直向右匹配直到遇到范围查询(`>、<、between、like`)就停止匹配，比如`a = 1 and b = 2 and c > 3 and d = 4` 如果建立`(a,b,c,d)`顺序的索引，d是用不到索引的，如果建立`(a,b,d,c)`的索引则都可以用到，a,b,d的顺序可以任意调整。 
2.  较频繁作为查询条件的字段才去创建索引 
3.  更新频繁字段不适合创建索引 
4.  尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。 
5.  定义有外键的数据列一定要建立索引。
6.  对于那些查询中很少涉及的列，重复值比较多的列不要建立索引。 
7.   对于定义为text、image和bit的数据类型的列不要建立索引。 

## MySQL中的页

###  解释

MySQL中和磁盘交互的最小单位称为页，页是MySQL内部定义的一种数据结构，默认为16kb，相当于4个磁盘块，也就是说MySQL每次从磁盘中读取一次数据是16KB，要么不读取，要读取就是16KB，此值可以修改的。 

### 页结构

 MySQL中页是InnoDB 中存储数据的基本单位，也是MySQL中管理数据的最小单位，和磁盘交互的时候都是以页来进行的，默认是16kb，MySQL中采用b+树存储数据，页相当于b+树中的一个节点。 